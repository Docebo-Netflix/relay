<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Docebo → Relay → Watershed (xAPI Test Console)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self';
                 connect-src 'self' https:;
                 frame-ancestors *;">
  <style>
    :root { --bg:#0b0c10; --panel:#11141a; --text:#e8eef5; --muted:#9aa4b2; --ok:#22c55e; --warn:#f59e0b; --bad:#f87171; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width: 980px; margin: 28px auto; padding: 0 16px; }
    h1 { font-size: 1.15rem; margin: 0 0 12px; }
    .card { background: var(--panel); border: 1px solid #1e2633; border-radius: 14px; padding: 16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; align-items:flex-end; }
    .row > * { flex: 1 1 240px; }
    label { display:block; font-size:.85rem; color:var(--muted); margin-bottom:6px; }
    input, select, textarea {
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3140;
      background:#0f131a; color:var(--text); box-sizing:border-box;
    }
    textarea { min-height: 110px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    button { cursor:pointer; border:0; border-radius:10px; padding:10px 14px; background:#334155; color:#fff; }
    button.secondary { background:#1f2937; }
    button.danger { background:#7f1d1d; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:.85rem; }
    .ok { background: rgba(34,197,94,.15); color: var(--ok); }
    .warn { background: rgba(245,158,11,.15); color: var(--warn); }
    .bad { background: rgba(248,113,113,.15); color: var(--bad); }
    .log { max-height: 260px; overflow:auto; background:#0b0f14; border:1px solid #1f2430; border-radius: 10px; padding: 10px; font-size: .9rem; }
    .muted { color: var(--muted); }
    .small { font-size: .85rem; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 900px) { .grid2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Docebo → Relay → Watershed (xAPI Test Console)</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>Relay endpoint (POST) — this is your Render server</label>
          <input id="relay" class="mono" value="https://xapi-tracking.onrender.com/track" />
          <div class="small muted">Keep Watershed Key/Secret on the relay server only (Render env vars).</div>
        </div>
        <div>
          <label>Activity/Object ID (stable identifier)</label>
          <input id="activity" class="mono" value="https://docebo-netflix.github.io/xapi-tracking/" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Actor user_id (preferred join key)</label>
          <input id="user_id" placeholder="e.g., 123456" />
        </div>
        <div>
          <label>Actor username</label>
          <input id="username" placeholder="e.g., Ed" />
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div>
          <label>Actor email (optional; usually not provided by Docebo iFrame)</label>
          <input id="email" placeholder="edwardin@netflixcontractors.com" />
        </div>
        <div>
          <label>Verb</label>
          <select id="verb">
            <option value="initialized">initialized (Start)</option>
            <option value="interacted" selected>interacted (Click/Heartbeat)</option>
            <option value="terminated">terminated (Stop)</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <label>Action key (what happened)</label>
          <input id="action" value="hub_asset_click" />
        </div>
        <div>
          <label>Destination URL (optional)</label>
          <input id="dest" class="mono" placeholder="https://..." />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Referrer/Page URL (optional)</label>
          <input id="ref" class="mono" placeholder="https://netflixsandbox.docebosaas.com/pages/..." />
        </div>
        <div>
          <label>Auto-heartbeat</label>
          <select id="autoBeat">
            <option value="off" selected>Off</option>
            <option value="on">On (every 30s)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <button id="sendBtn">Send event</button>
        <button class="secondary" id="startBtn">Start session</button>
        <button class="danger" id="stopBtn">Stop session</button>
        <span id="status" class="pill warn">idle</span>
      </div>

      <div class="row small muted">
        <div>Last POST (ms): <span class="mono" id="lastMs">—</span></div>
        <div>Now: <span class="mono" id="now">—</span></div>
      </div>

      <div class="row">
        <div style="flex: 1 1 100%">
          <label>Docebo iframe params detected (debug)</label>
          <textarea id="detected" class="mono" readonly>(loading...)</textarea>
          <div class="small muted">
            If this shows nothing, Docebo may not be injecting signed params in this view (try published learner view).
          </div>
        </div>
      </div>

      <div class="row">
        <div style="flex: 1 1 100%">
          <label>Payload preview (what will be POSTed to your relay)</label>
          <textarea id="payloadPreview" class="mono" readonly></textarea>
        </div>
      </div>

      <div class="row">
        <button class="secondary" id="copyBtn">Copy payload JSON</button>
        <button class="secondary" id="clearBtn">Clear log</button>
      </div>

      <div class="log mono" id="log"></div>

      <hr style="border:0;border-top:1px solid #1e2633;margin:16px 0">

      <div class="row">
        <div style="flex:1 1 520px">
          <label>Redirect test URL builder (optional)</label>
          <div class="small muted">Build a URL you can paste into the Hub as a link target.</div>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Redirect page URL (GitHub Pages)</label>
          <input id="redirectBase" class="mono" value="https://docebo-netflix.github.io/xapi-tracking/redirect.html" />
        </div>
        <div>
          <label>Generated redirect URL</label>
          <input id="generatedUrl" class="mono" readonly />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="secondary" id="buildUrlBtn">Build URL</button>
        <button class="secondary" id="openUrlBtn">Open built URL</button>
      </div>

      <p class="small muted">
        Tip: open DevTools → Network and filter for <span class="mono">/track</span> to verify POSTs and timing.
      </p>
    </div>
  </div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const logEl = $("log");
  const statusEl = $("status");
  const payloadEl = $("payloadPreview");
  const detectedEl = $("detected");
  const lastMsEl = $("lastMs");
  const nowEl = $("now");

  let beatTimer = null;

  function log(msg) {
    const t = new Date().toLocaleTimeString();
    logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
  }

  function setStatus(kind, text) {
    statusEl.className = `pill ${kind}`;
    statusEl.textContent = text;
  }

  function qs() {
    return new URLSearchParams(location.search);
  }

  function detectDoceboParams() {
    const p = qs();
    const keys = ["user_id","username","auth_code","hash","signature","uid","user","email"];
    const found = {};
    keys.forEach(k => {
      if (p.has(k)) found[k] = p.get(k);
    });
    detectedEl.value = Object.keys(found).length ? JSON.stringify(found, null, 2) : "(none detected)";
    return found;
  }

  function buildPayload(verbOverride) {
    const detected = detectDoceboParams();

    const relay = $("relay").value.trim();
    const activity_id = $("activity").value.trim();
    const action = $("action").value.trim();
    const destination = $("dest").value.trim();
    const referrer = $("ref").value.trim() || document.referrer || "";

    // Prefer Docebo params if present
    const user_id = detected.user_id || $("user_id").value.trim();
    const username = detected.username || $("username").value.trim();
    const email = detected.email || $("email").value.trim();

    const verb = verbOverride || $("verb").value;

    const payload = {
      type: "docebo_hub_event",
      verb,
      action,
      activity_id,
      destination,
      referrer,
      actor: {
        user_id: user_id || "",
        username: username || "",
        email: email || ""
      },
      context: {
        page_url: location.href,
        user_agent: navigator.userAgent
      },
      timestamp: new Date().toISOString()
    };

    payloadEl.value = JSON.stringify(payload, null, 2);
    return { relay, payload };
  }

  async function postToRelay(verbOverride) {
    const t0 = performance.now();
    const { relay, payload } = buildPayload(verbOverride);

    if (!relay) {
      setStatus("bad","missing relay");
      log("ERROR: relay endpoint is empty.");
      return;
    }

    try {
      setStatus("warn","sending...");
      const resp = await fetch(relay, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload),
        keepalive: true
      });
      const ms = Math.round(performance.now() - t0);
      lastMsEl.textContent = String(ms);

      const txt = await resp.text().catch(()=> "");
      if (!resp.ok) {
        setStatus("bad",`HTTP ${resp.status}`);
        log(`FAIL ${resp.status} in ${ms}ms: ${txt || "(no body)"}`);
        return;
      }
      setStatus("ok","sent");
      log(`POST ok (${resp.status}) in ${ms}ms — verb=${payload.verb} action=${payload.action}`);
    } catch (e) {
      setStatus("bad","error");
      log(`ERROR: ${String(e)}`);
    }
  }

  function updateClock() { nowEl.textContent = new Date().toISOString(); }

  $("sendBtn").addEventListener("click", () => postToRelay());
  $("startBtn").addEventListener("click", () => postToRelay("initialized"));
  $("stopBtn").addEventListener("click", () => postToRelay("terminated"));

  $("copyBtn").addEventListener("click", async () => {
    try { await navigator.clipboard.writeText(payloadEl.value); log("Copied payload JSON."); }
    catch { log("Could not copy (browser blocked)."); }
  });

  $("clearBtn").addEventListener("click", () => logEl.textContent = "");

  $("autoBeat").addEventListener("change", (e) => {
    if (beatTimer) { clearInterval(beatTimer); beatTimer = null; }
    if (e.target.value === "on") {
      beatTimer = setInterval(() => postToRelay("interacted"), 30000);
      log("Auto-heartbeat enabled (30s).");
    } else {
      log("Auto-heartbeat disabled.");
    }
  });

  $("buildUrlBtn").addEventListener("click", () => {
    const base = $("redirectBase").value.trim();
    const { payload } = buildPayload(); // uses current form values
    const u = new URL(base);
    u.searchParams.set("dest", $("dest").value.trim() || "https://netflixsandbox.docebosaas.com/");
    u.searchParams.set("act", $("action").value.trim() || "hub_asset_click");
    u.searchParams.set("aid", $("activity").value.trim());
    // don't pass secrets; passing actor values is optional for testing only
    if ($("email").value.trim()) u.searchParams.set("email", $("email").value.trim());
    if ($("username").value.trim()) u.searchParams.set("username", $("username").value.trim());
    if ($("user_id").value.trim()) u.searchParams.set("user_id", $("user_id").value.trim());
    $("generatedUrl").value = u.toString();
    log("Built redirect URL.");
  });

  $("openUrlBtn").addEventListener("click", () => {
    const url = $("generatedUrl").value.trim();
    if (!url) return log("No generated URL yet.");
    window.open(url, "_blank", "noopener,noreferrer");
  });

  // init
  detectDoceboParams();
  buildPayload();
  updateClock();
  setInterval(updateClock, 1000);
})();
</script>
</body>
</html>
