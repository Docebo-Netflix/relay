<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Redirecting…</title>
</head>
<body>
<script>
(() => {
  const qs = new URLSearchParams(location.search);

  // ✅ 1) Get dest/act from THIS URL (reliable)
  let dest = qs.get('dest') || '';
  let act  = qs.get('act')  || 'unknown_click';

  // 2) Identity that Docebo appends (Advanced Settings)
  const userId   = qs.get('user_id')   || '';
  const username = qs.get('username')  || '';
  const authCode = qs.get('auth_code') || '';
  const hash     = qs.get('hash')      || '';

  // (Optional) fallback: try referrer if dest wasn’t passed
  if (!dest) {
    try {
      const ref = document.referrer || '';
      if (ref) {
        const refUrl = new URL(ref);
        dest = refUrl.searchParams.get('dest') || dest;
        act  = refUrl.searchParams.get('act')  || act;
      }
    } catch (_) {}
  }

  // Safety: only allow http(s)
  const safeDest = /^https?:\/\//i.test(dest) ? dest : '';

  const payload = {
    type: "hub_redirect_click",
    timestamp: new Date().toISOString(),
    actor: { user_id: userId, username },
    action: act,
    destination: safeDest,
    context: {
      href: location.href,
      referrer: document.referrer || '',
      auth_code_present: !!authCode,
      hash_present: !!hash
    }
  };

  const RELAY_ENDPOINT = "https://xapi-tracking.onrender.com/track";

  // send tracking
  let sent = false;
  try {
    sent = navigator.sendBeacon(
      RELAY_ENDPOINT,
      new Blob([JSON.stringify(payload)], { type: "application/json" })
    );
  } catch (_) {}

  if (!sent) {
    fetch(RELAY_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      keepalive: true
    }).catch(() => {});
  }

  // redirect
  if (safeDest) {
    window.top.location.replace(safeDest);
  } else {
    document.body.innerText =
      "Missing/unsafe destination URL. Pass ?dest=https%3A%2F%2Fexample.com&act=hub_click";
  }
})();
</script>
</body>
</html>
